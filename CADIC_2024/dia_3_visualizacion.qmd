---
title: | 
  | Visualizaci칩n y an치lisis exploratorio de datos
subtitle: "Curso: Programaci칩n y an치lisis estad칤stico en R. CADIC, Ushuaia, Argentina"
author: 
  - name: Ver칩nica Cruz-Alonso 
    roles: "Profesora y autora del material"
date: today
date-format: "DD/MM/YYYY"
toc: true
toc-depth: 4
toc-title: "칈ndice"
format:
  html:
    link-external-newwindow: true
    # css: styles.css
  gfm: default
editor: visual
editor_options: 
  chunk_output_type: console
number-sections: true
bibliography: references.bib
---

## Objetivos del d칤a 3

-   Aprender la filosof칤a y funciones b치sicas del paquete de visualizaci칩n de datos {ggplot2}.

-   Entender y aplicar funciones avanzadas de {ggplot2}.

-   Ser capaces de generar gr치ficos publicables en un art칤culo cient칤fico.

-   Aprender a explorar diferentes tipos de datos para su posterior an치lisis.

## Introducci칩n a la visualizaci칩n de datos

La visualizaci칩n de datos es una disciplina cuyo fin es mapear datos de forma gr치fica para comunicar un mensaje. En investigaci칩n se usa principalmente en los an치lisis exploratorios (durante la fase de entendimiento de los datos) y en la comunicaci칩n de los resultados.

La representaci칩n gr치fica de nuestras ideas o resultados de investigaci칩n es esencial para comunicar de forma efectiva nuestra interpretaci칩n de los datos y es clave si queremos causar cierto impacto en el interlocutor. Algunos estudios sugieren que el tiempo medio que el usuario emplea en ojear una p치gina web es de unos segundos, pero si hay algo que consigue atraer su atenci칩n entonces el tiempo se incrementa exponencialmente. Este atractor en el mundo cient칤fico puede ser un buen gr치fico de resultados o un buen resumen gr치fico.

![Esquema conceptual de un "buen gr치fico" considerando la ejecuci칩n (c칩mo de bien est치 constituido) y la adecuaci칩n (qu칠 estoy tratando de decir, a qui칠n, d칩nde, por qu칠). Modificado de [Good Charts de Scott Berinato](https://scottberinato.com/good-charts-book/).](images/buen-grafico.png){width="469"}

En este bloque vamos a aprender como representar de manera efectiva muestros datos utilizando el paquete {[ggplot2](https://ggplot2.tidyverse.org/)} de *tidyverse*. {ggplot2} permite hacer gr치ficos razonablemente claros y est칠ticamente bonitos (es decir, bien ejecutados) con poco tiempo y un esfuerzo peque침o. Es extremadamente flexible y potente por lo que ha alcanzado gran popularidad.

{ggplot2} est치 escrito en R siguiendo la [gram치tica de gr치ficos (gg)](https://www.amazon.com/Grammar-Graphics-Statistics-Computing/dp/0387245448/ref=as_li_ss_tl). Por ello, al utilizarlo, el usuario tiene que pensar como cuando est치 haciendo un dibujo a mano y pensar en ir a침adiendo diferentes capas a la creaci칩n. El flujo de trabajo es crear un gr치fico vac칤o, a침adir una capa con los datos, a침adir una capa con las etiquetas, etc.

![Creaci칩n de una pintura por capas, como en la gram치tica de gr치ficos. https://www.donnacowan.ca/category/animated-gifs/](images/Buckley-Bay-Oil-Painting-Animation-6x8-2.gif){width="441"}

Otra caracter칤stica de {ggplot2} adem치s del trabajo por capas es que precisa de datos ordenados para que se ejecute de forma 칩ptima.

游눠Recordamos que en una tabla de datos ordenados (*Tidy data*) cada columna representa una variable, cada fila es una observaci칩n y cada celda contiene un 칰nico valor.

## Elementos b치sicos en un gr치fico de {[ggplot2](https://ggplot2.tidyverse.org/)}

Se necesitan tres capas b치sicas para crear un gr치fico con {ggplot2}:

-   Los datos (*data*).

-   Las geometr칤as (*geom*): definen el tipo de gr치fico (de puntos, de barras, etc.).

-   Los *aesthetics*: caracter칤sticas visuales de las geometr칤as (p. ej. la posici칩n, el color) definidas por las variables de nuestros datos.

Las capas se conectan entre s칤 con el s칤mbolo `+`, que siempre debe ir colocado al final de la l칤nea de c칩digo si queremos seguir a침adiendo capas al gr치fico. Todas las capas que se pueden incluir est치n recogidas en la [cheat sheet de {ggplot2} de Posit](https://diegokoz.github.io/intro_ds/fuentes/ggplot2-cheatsheet-2.1-Spanish.pdf).

游눠 Se utiliza el s칤mbolo `+` porque {ggplot2} es anterior al *pipe* (`|>`) y cambiar `+` por el *pipe* requer칤r칤a muchos reajustes en un mont칩n de paquetes.

```{r capas_basicas}
#| warning: false

# install.packages("titanic")
library(tidyverse)

#Cargamos los datos
titanic <- titanic::titanic_train 

head(titanic)
# PassengerId: Id del pasajero
# Survived: 1-si, 0-no
# Pclass: clase del pasajero
# Name: nombre Name
# Sex: sexo
# Age: edad
# SibSp: numero de hermanos + parejas a bordo
# Parch: numero de progenitores + hijos a bordo
# Ticket: numero de billete
# Fare: tarifa
# Cabin: camarote
# Embarked: puerta de embarque

ggplot(data = titanic)

ggplot(data = titanic, aes(x = Age, y = Fare)) 

ggplot() + 
  geom_point(data = titanic, aes(x = Age, y = Fare)) #Los datos se pueden colocar dentro de la funcion ggplot si se van a usar los mismos en todas las geometrias

ggplot() + 
  geom_jitter(data = titanic, aes(x = Pclass, y = Fare))

# Como guardar plots satisfactorios

plotqmegusta <- ggplot() + 
  geom_point(data = titanic, aes(x = Age, y = Fare))

ggsave(filename = "farebyage.jpg", plot = plotqmegusta, width = 12, height = 9, units = "cm", dpi = 300)

ggsave(filename = "farebyage.pdf", plot = plotqmegusta, width = 12, height = 9, units = "cm")

# Se pueden combinar varias geometrias

ggplot(data = titanic) + 
  geom_point(aes(x = Age, y = Fare)) + 
  geom_smooth(aes(x = Age, y = Fare))
```

游눠Algunas revistas cient칤ficas dan especificaciones muy detalladas sobre c칩mo tienen que ser los gr치ficos (p. ej. [Science](https://www.science.org/content/page/instructions-preparing-initial-manuscript#preparation-of-figures)). Cuando no tenemos una referencia clara recomendamos pensar en formato A4 (21 x 29,7 cm) y que todos los elementos visuales del gr치fico queden visibles cuando se guarda dentro de estos l칤mites de tama침o.

#### Ejercicio

Representa un gr치fico para ver la relaci칩n entre el sexo de los pasajeros y la clase.

### Aesthetics vs. argumentos

Los aesthetics cambian cada elemento de las geometr칤as. Los argumentos est칠ticos cambian toda la geometr칤a en conjunto.

```{r aes_arguments}
#| warning: false

ggplot(data = titanic) + 
  geom_point(aes(x = Age, y = Fare, color = Sex))

# No es lo mismo que... 

ggplot(data = titanic) + 
  geom_point(aes(x = Age, y = Fare), color = "darkred") 
```

En la ayuda de las funciones de {ggplot2} aparece una lista de los *aesthetics* y los argumentos est칠ticos que acepta esa funci칩n. Se pueden incluir tantos *aesthetics* como se deseen.

```{r aes}
#| warning: false

ggplot(data = titanic) + 
  geom_point(aes(x = Age, y = Fare, size = Pclass, shape = Sex, color = Embarked))

summary(titanic$Pclass)

titanic <- titanic |> 
  mutate(Pclass = factor(Pclass, levels = c(3, 2, 1), 
    labels = c("Tercera", "Segunda", "Primera")))

summary(titanic$Pclass)

ggplot(data = titanic) + 
  geom_point(aes(x = Age, y = Fare, size = Pclass, shape = Sex, color = Embarked), alpha = 0.5)

```

#### Ejercicio

쮺칩mo modificar칤as el siguiente c칩digo para representar la puerta de embarque con diferentes formas pero los puntos de color rosa?

```{r ejer_2}
#| warning: false

ggplot(data = titanic) + 
  geom_point(aes(x = Age, y = Fare))

```

## {Ggplot2}: funciones avanzadas

<!--# ver la chuleta de ggplot2 -->

### Etiquetas

```{r etiquetas}
#| warning: false  

pnumcat <- ggplot(data = titanic) +    
  geom_boxplot(aes(x = Pclass, y = Age))  
pnumcat  

pnumcat +    
  labs(title = "Edad de los pasajeros seg칰n su clase",      
    x = "Clase",      
    y = "Edad (a침os)") #title, subtitle, x, y, caption
```

### Sistema de coordenadas

El sistema de coordenadas por defecto en un gr치fico de `ggplot()` es el cartesiano. Si queremos hacer zoom en nuestro gr치fico tendremos que cambiar los l칤mites del sistema de coordenadas.

```{r coords}
#| warning: false  

pnumcat +   
  coord_cartesian(ylim = c(0, 100))  
```

#### Ejercicio

Cambia la posici칩n de los ejes X e Y en el sistema de coordenadas de pnumcat.

### Faceting

Los *facets* dividen el gr치fico en subgr치ficos basados en el valor de una o varias variables categ칩ricas. Las facetas son muy 칰tiles en exploraci칩n de datos. Hay dos funciones para facetar: `facet_grid()` y `facet_wrap()`.

```{r facet_1}
#| warning: false  

miplot2 <- ggplot(data = titanic,    
  aes(x = Age, y = Fare, color = Sex)) +    
  geom_point()  
miplot2  

miplot2 +    
  facet_grid(rows = vars(Pclass), scales = "free")  

miplot2 +    
  facet_grid(rows = vars(Pclass), cols = vars(Embarked))  

miplot2 +    
  facet_wrap(facets = vars(Embarked), ncol=3)
```

### Posici칩n

Con las funciones y argumenos de posici칩n podemos recolocar geometrias que de otro modo ocupar칤an el mismo espacio.

```{r posicion}
#| warning: false  

ggplot(data = titanic) +    
  geom_bar(aes(x = Pclass, fill = Sex))  

ggplot(data = titanic) +    
  geom_bar(aes(x = Pclass, fill = Sex), 
    position = "dodge") #esquivar  

ggplot(data = titanic) +    
  geom_bar(aes(x = Pclass, fill = Sex), 
    position = "fill") #rellenar 
```

### Escalas

Sirven para personalizar los *aesthetics*. Las funciones de la familia `scale` siempre tienen la misma estructura: `scale_aesthetic` que se personaliza con \_ tipo de escala (p. ej. continua, discreta, manual, etc.).

```{r escala}
#| warning: false  

miplot2 +   
  scale_color_manual(values = c("darkgreen", "chartreuse")) +
  scale_y_sqrt(breaks = c(9,16,25), labels = c("a", "b","c"))  
```

游 Un error muy com칰n es cambiar los ejes del gr치fico con las funciones `scale_x_continuous()` o `scale_y_continuous()` cuando lo que queremos es hacer zoom. Fijate en las diferencias en el siguiente ejemplo.

```{r plot_limits}
#| warning: false  

ggplot(data = titanic) +    
  geom_boxplot(aes(x = Pclass, y = Age))  

ggplot(data = titanic) +    
  geom_boxplot(aes(x = Pclass, y = Age)) + 
  scale_y_continuous(limits = c(10, 80))  

ggplot(data = titanic) +    
  geom_boxplot(aes(x = Pclass, y = Age)) +   
  coord_cartesian(ylim = c(10, 80)) 
```

#### Ejercicio

쯈u칠 har칤as para cambiar la escala de la edad a un degradado de colores de azul a amarillo en el siguiente gr치fico?

```{r ejer}

ggplot(data = titanic, aes(x = Age, y = Fare, color = Age)) +   geom_point(size = 10)  
```

### Los colores en R

Las paletas de colores tipo *manual* y *gradient* se personalizan con el nombre o c칩digo del color.

游눠Con [esta herramienta](https://r-charts.com/colors/) puedes elegir entre cientos de colores y con [esta](https://medialab.github.io/iwanthue/) crear tu propia paleta.

Las paletas tipo *brewer* y *distiller* utilizan paletas de colores que pueden ser secuenciales, cualitativas o divergentes, que aunque tienen utilidad en gran variedad de situaciones, est치n dise침adas para trabajar [con mapas o a escalas peque침as](https://colorbrewer2.org/#type=sequential&scheme=BuGn&n=3).

Las paletas HCL (*hue-chroma-luminance*) son paletas muy populares que tienen su propia funci칩n (p. ej. colores para representar batimetr칤a). De entre ellas, *Viridis* se he vuelto muy popular porque est치 dise침ada para que personas con distintos tipos de daltonismo puedan distinguir los colores.

```{r paletas}
#| warning: false  

RColorBrewer::display.brewer.all()   
RColorBrewer::brewer.pal(name = "Set3", n = 6) # para crear paleta  

grDevices::hcl.pals() # HCL Palettes   

X11() 
example("hcl.colors") 
hcl.colors(n = 6, palette = "Lajolla") # para crear paleta 

# Viridis   
ggplot(data = titanic, aes(x = Age, y = Fare, color = Age)) +
  geom_point() +    
  scale_color_gradientn(colours = hcl.colors(12, "viridis")) 

ggplot(data = titanic, aes(x = Age, y = Fare, color = Age)) +    geom_point() +    
  scale_color_viridis_c()
```

游눠[Aqu칤](https://ggplot2-book.org/scales-colour) puedes encontrar m치s informaci칩n sobre c칩mo utilizar colores en {ggplot2}.

### Temas

`theme()` permite la personalizaci칩n completa de todos los elementos del gr치fico. Los argumentos dentro de la funci칩n definen la parte del gr치fico a cambiar. Se les asigna una funci칩n de cambio seg칰n el elemento a cambiar dentro de esa parte (parte.del.gr치fico = elemento_a_cambiar(...)): *line*, *rect*, *text*.

```{r theme}
#| warning: false  

?theme  
miplot2 +    
  theme(axis.title.x = element_text(color = "red", face = "bold"))  
```

#### Ejercicio

Dibuja una linea negra que represente los ejes de miplot y quita el fondo del gr치fico.

Existen temas configurados por defecto y un asistente que te ayuda a personalizar el gr치fico.

```{r temas_defecto}
#| warning: false  

miplot2 + theme_classic()  
miplot2 + theme_light()  
miplot2 + theme_void() 
```

#### GgthemeAssist

```{r theme_assist}

# install.packages("ggThemeAssist")  
miplot2
```

## La exploraci칩n de datos y su importancia

Cuando queremos entender y/o predecir un patr칩n o un proceso (variable dependiente o respuesta; *y*), lo modelizamos en funci칩n de otras variables que pensamos que lo explican o lo predicen (variables independientes, covariables o explicativas; *x*). Todas ellas pueden ser a su vez **cualitativas o cuantitativas**.

![Tipos de variables](images/tipos_variables.png)

La exploraci칩n de datos puede llevar hasta el 50% del tiempo de an치lisis. Es imprescindible para evitar errores tipo I (determinar que hay relaci칩n entre dos variables cuando no existe), errores tipo II (determinar que no hay relaci칩n entre dos variables cuando existe), encontrar patrones no lineales o evitar que el resultado est칠 determinados por unos pocos puntos discordantes (*outliers*). A continuaci칩n nos vamos a enfocar en herramientas gr치ficas para la exploraci칩n de variables cualitativas y cuantitativas aunque tambi칠n mostraremos test estad칤sticos que pueden servir (de normalidad, homogeneidad, skewness, etc.). Seguiremo el protocolo de an치lisis exploratorio de datos publicado por @zuur2010.

### Detecci칩n de outliers

#### En una variable

```{r outliers_one}
#| warning: false

library(palmerpenguins)

ggplot(data = titanic) + 
  geom_boxplot(aes(y = Age))

ggplot(data = titanic) + 
  geom_jitter(aes(x = 1, y = Age))

# Cleveland plot
penguins |> 
  mutate(orden = 1:nrow(penguins)) |> 
  ggplot() + 
  geom_point(aes(x = body_mass_g, y = orden)) +
  theme(panel.grid = element_blank(),
    panel.grid.major.y = element_line(size = 0.1, color = "grey90"), 
    panel.background = element_rect(fill = "white", color = "black")) 

```

#### Outliers condicionales

```{r outliers_dos}
#| warning: false 

# De variables continuas codicionados por variables categ칩ricas

# Cleveland plot por grupos
penguins |> 
  group_by(island) |> 
  mutate(orden = 1:n()) |> 
  ggplot() + 
  geom_point(aes(x = body_mass_g, y = orden, col = island)) +
  facet_grid(island ~ ., scales = "free_y", space = "free_y") + 
  theme(panel.grid = element_blank(),
        panel.grid.major.y = element_line(size = 0.1, color = "grey90"), 
    panel.background = element_rect(fill = "white", color = "black"),
        legend.position = "none")

# Boxplots
ggplot(data = titanic) + 
  geom_boxplot(aes(y = Age))

ggplot(data = titanic) + 
  geom_bar(aes(x = Pclass, group = 1)) 
# group = 1 hace que considere toda la variable como un todo

ggplot(data = titanic) + 
  geom_boxplot(aes(x = Pclass, y = Age)) 

# De variables continuas codicionados por otras variables continuas

ggplot(data = penguins) + 
  geom_point(aes(x = body_mass_g, y = flipper_length_mm)) 

```

#### 쯈u칠 podemos hacer con los outliers?

```{r outliers_gestion}
#| warning: false

# Identificar outliers: 쯔 qu칠 observaci칩n pertenecen?

# install.packages("plotly")
library(plotly)

miplot <- ggplot(data = titanic) + 
  geom_boxplot(aes(x = Pclass, y = Age)) 

ggplotly(miplot) 
# Comprobar los residuos del modelo que ajustemos para estas observaciones

penguins |> 
  mutate(orden = 1:nrow(penguins)) |> 
 ggplot() + 
  geom_point(aes(x = body_mass_g, y = flipper_length_mm)) +
  geom_text(aes(x = body_mass_g, y = flipper_length_mm, label = orden), col = "red") 

# Gestionar outliers con transformaciones

pellets <- read_delim(file = "pellets.txt") 
# Longitud y peso de heces de un gusano marino

ggplot(data = pellets) +
  geom_boxplot(aes(y = Length)) 

pellets |> 
  mutate(orden = 1:n()) |> 
  ggplot() + 
  geom_point(aes(x = Length, y = orden)) +
  theme(panel.grid = element_blank(),
        panel.grid.major.y = element_line(size = 0.1, color = "grey90"), 
    panel.background = element_rect(fill = "white", color = "black"),
        legend.position = "none")

pellets |> 
  mutate(orden = 1:n()) |> 
  ggplot() + 
  geom_point(aes(x = log10(Length), y = orden)) +
  theme(panel.grid = element_blank(),
        panel.grid.major.y = element_line(size = 0.1, color = "grey90"), 
    panel.background = element_rect(fill = "white", color = "black"),
        legend.position = "none")

ggplot(data = pellets) +
  geom_boxplot(aes(y = log10(Length))) 

# Esta transformaci칩n acorta distancia hacia la derecha (quita outliers)
# pero alarga algo las que est치n hacia la izquierda, sobre todo cuanto m치s cerca de 0 

```

### Normalidad y homogeneidad de Y

Los supuestos de normalidad y homogeneidad en las regresiones lineales deber칤an comprobarse sobre los residuos (diferencia entre el valor observado y el valor predicho) de la regresi칩n a lo largo de las variables explicativas. Sin embargo, para esto necesitar칤amos tener muchas observaciones en cada valor de la variable explicativa. En ecolog칤a esto rara vez ocurre as칤 que se acaban comprobando los supuestos sobre el total de los residuos. Tambi칠n se exploran las variables explicativas en este sentido, ya que si estas son normales y homog칠neas es probable que los residuos tambi칠n lo sean.

![Visualizaci칩n de las asunciones de normalidad y homogeneidad en regresiones lineales. Los puntos representan los valores observados y la l칤nea es la l칤nea de regresi칩n. En cada valor de la covariable asumiminos que las observaciones est치n distribuidas de forma normal y con la misma dispersi칩n. Extraido de @zuur2010.](images/clipboard-1650594255.png){#sup width="367"}

```{r homogeneidad}
#| warning: false

# Una variable en las categorias de otra

ggplot(data = titanic) + 
  geom_boxplot(aes(y = Fare, fill = Pclass), alpha = 0.7)

ggplot(data = titanic) + 
  geom_density(aes(x = Fare, fill = Pclass), alpha = 0.7)

# La relaci칩n de dos variables en las categorias de otra

ggplot(data = titanic) + 
  geom_point(aes(y = Fare, x = Age, color = Pclass), alpha = 0.7)

# Test de homogeneidad

# instal.packages(lawstat)
library(lawstat)

bartlett.test(Fare~Pclass, data = titanic) 
# p < 0.05 se rechaza hip칩tesis nula 
# H0: distribuci칩n de la variable = distribuci칩n homog칠nea

lawstat::levene.test(y = titanic$Fare, group = titanic$Pclass)

# Pensar en los plots, en los residuos del modelo y no fiarse 100% de estos tests

```

```{r normalidad}
#| warning: false

# Histogramas y curvas de densidad para una variable

ggplot(data = titanic) + 
  geom_histogram(aes(x = Age))

ggplot(data = titanic) + 
  geom_density(aes(x = Age))

ggplot(data = titanic) + 
  geom_boxplot(aes(x = Age))

#Con variables cualitativas
summary(titanic$Pclass)

ggplot(data = titanic) + 
  geom_bar(aes(x = Pclass))

# Una variable en las categorias de otra

titanic |> 
  ggplot() +
  geom_histogram(aes(x = Age), bins = 20) +
  facet_grid(Pclass~.) 

ggplot(penguins) +
  geom_density(aes(x = body_mass_g), color = "darkred") +
  geom_density(aes(x = body_mass_g, group = island, linetype = island))

# Q-Q plots 

ggplot(titanic) +
  geom_qq(aes(sample = Age)) +
  geom_qq_line(aes(sample = Age), color = "darkred") +
  labs(x = "Cuantiles te칩ricos", y = "Edad")

ggplot(titanic) +
  geom_qq(aes(sample = Age)) +
  geom_qq_line(aes(sample = Age), color = "darkred") +
  labs(x = "Cuantiles te칩ricos", y = "Edad") +
  facet_grid(.~Pclass)

# Tests de normalidad 

a <- rnorm(800, mean = 0, sd = 1) # Creo dos variables normales y estandarizadas 
b <- rnorm(50, mean = 0, sd = 1)

hist(a)
hist(b)
qqnorm(a)
qqnorm(b)

shapiro.test(a) # p < 0.05 se rechaza hip칩tesis nula 
# H0: distribuci칩n de la variable = distribuci칩n normal
shapiro.test(b)

ks.test(a, "pnorm") # Kolmogorow-Smirnoff
ks.test(b, "pnorm")

# OJO con la normalidad en los residuos. No se recomienda estos tests, 
# ya que est치n muy sesgados al n칰mero de muestras. Adem치s, tambi칠n se
# permite cierta desviaci칩n de la normalidad en los residuos.
# Los tests son muy restrictivos

```

#### Ejercicio

Describe la distribuci칩n de las tarifas pagadas por los pasajeros.

Haz un histograma y cambia el n칰mero de intervalos para ver como cambia la distribuci칩n de la variable.

### Cantidad de ceros

```{r ceros}

titanic |> 
  ggplot() + 
  geom_bar(aes(x = SibSp == 0))

titanic |> 
  ggplot() + 
  geom_count(aes(x = SibSp == 0, y = Parch == 0))

```

### Relaciones entre variables

La **colinealidad** es la existencia de correlaci칩n entre covariables de un modelo. Un ejemplo t칤pico en ecolog칤a es la altitud con la precipitaci칩n o la temperatura. Si se ignora puede ocurrir que no haya nada significativo en el modelo o situaciones absurdas como que al quitar una covariable, el resto se hagan significativas. Aumentar el n칰mero de variables en el modelo hace que la R^2^ (coeficiente de determinaci칩n: cuanta de la variaci칩n de y es explicada por las covariables) aumente, pero tambi칠n la colinealidad. A mayor R^2^, mayores errores est치ndar de de los par치metros haciendo que los p-valores significativos sean m치s dif칤ciles de detectar.

Aparte de las relaciones entre covariables, es necesario explorar las **relaciones entre la variable respuesta y las explicativas**, sobre todo para encontrar posibles patrones no lineales.

#### Variables cualitativas

```{r dos_cat}
#| warning: false

ggplot(data = titanic) + 
  geom_count(aes(x = Sex, y = Survived))

titanic <- titanic |> 
  mutate(Survived = factor(Survived, levels = c(0, 1), labels = c("Muerto", "Vivo")))

ggplot(data = titanic) + 
  geom_count(aes(x = Sex, y = Survived))

table(titanic$Sex, titanic$Survived)

```

#### Ejercicio

Haz un gr치fico para averiguar en qu칠 clase sobrevivieron m치s personas.

#### Variables cuantitativas

```{r dos_num}
#| warning: false

pnum <- ggplot(data = titanic, aes(x = Age, y = Fare)) + 
  geom_point(alpha = 0.5)

pnum

pnum + 
  geom_smooth()

pnum + 
  geom_smooth() +
  facet_grid(.~Pclass)
```

Cuando encontramos relaciones no lineales, podemos transformar la variable explicativa para mejorar la linealidad con `log()`, `sqrt()`, etc. Esto puede reducir el peso de los outliers y mejorar tambi칠n la normalidad y homogeneidad de los residuos. Las desventajas son que la transformaci칩n puede afectar a la relaci칩n entre X e Y y entre las covariables y sus interacciones y es necesario deshacer la transformaci칩n a la hora de representar.

#### Variable cualitativa vs. cuantitativa

```{r cat_num}
#| warning: false

ggplot(data = titanic) + 
  geom_boxplot(aes(x = Pclass, y = Age))

ggplot(data = titanic) + 
  geom_violin(aes(x = Pclass, y = Age), draw_quantiles = 0.5) #+ 
# geom_jitter(aes(x = Pclass, y = Age), alpha = 0.3, width = 0.2)

ggplot(data = titanic) + 
  geom_violin(aes(x = Pclass, y = Age, fill = Sex), draw_quantiles = 0.5)

# Haciendo calculos previos

summ_titanic <- titanic |> 
  group_by(Pclass) |> 
  summarise(Avg_age = mean(Age, na.rm = TRUE), 
    Sd_age = sd(Age, na.rm = TRUE))

summ_titanic

ggplot(data = summ_titanic, aes(x = Pclass, y = Avg_age)) + 
  geom_col(color = "black") + 
  geom_errorbar(aes(ymax = Avg_age + Sd_age, 
    ymin = Avg_age - Sd_age), width = 0.25)

ggplot(data = summ_titanic, aes(x = Pclass, y = Avg_age)) + 
  geom_line(aes(group = 1))
```

游눠Echa un vistazo al paquete {[ggdist](https://mjskay.github.io/ggdist/)} y los [raincloud plots](https://www.cedricscherer.com/2021/06/06/visualizing-distributions-with-raincloud-plots-and-how-to-create-them-with-ggplot2/) para combinar diferentes geoms relacionadas con la distribuci칩n de los datos.

#### M칰ltiples covariables

[ggpairs()](https://ggobi.github.io/ggally/reference/ggpairs.html) de {GGally} permite hacer gr치ficos multipanel donde, de un vistazo, se ve la distribuci칩n de cada variable dentro de una base de datos y la relaci칩n de las variables todas entre s칤. Es muy 칰til en exploraci칩n de datos.

```{r pairs}
#| warning: false

# install.packages("GGally")
library(GGally)

penguins |> select(bill_length_mm:body_mass_g) |> 
  ggpairs()

penguins |> select(bill_length_mm:body_mass_g, sex) |> 
  filter(!is.na(sex)) |> 
  ggpairs(aes(color = sex),
  lower = list(continuous = wrap("smooth", method = "loess",    color = "darkslategrey", alpha = 0.1)),
  diag = list(continuous = wrap("barDiag")))

```

Los correlogramas, gr치ficos cuadrados o triangulares que representan matrices de correlaciones entre variables, son muy 칰tiles para resumir en un vistazo las relaciones entre las variables de una base de datos. En [este art칤culo](https://rpubs.com/Alema/1000474) encontrar치s tutoriales para realizarlos utilizando diferente paquetes.

```{r corr}

penguins_cor <- penguins |> select(bill_length_mm:body_mass_g) |> 
  na.omit() |> 
  cor() 

# install.packages("corrplot")

library(corrplot)
corrplot(penguins_cor)
```

## Gr치ficos multipaneles

La librer칤a {patchwork} permite a침adir gr치ficos ([y tambi칠n tablas](https://www.tidyverse.org/blog/2024/09/patchwork-1-3-0/)) entre s칤 como si fueran diferentes capas.

```{r patchwork}
#| warning: false

# install.packages("patchwork")
library(patchwork)

miplot + miplot2 
miplot / miplot2

miplot / miplot2 + 
  plot_annotation(tag_levels = "a", tag_suffix = ")") 

```

En [este enlace](https://patchwork.data-imaginist.com/articles/guides/layout.html) puedes ver c칩mo personalizar mucho m치s la disposici칩n de los diferentes elementos de la composici칩n.

## Enlaces de inter칠s

-   [Gu칤a de {ggplot2} de Posit](https://diegokoz.github.io/intro_ds/fuentes/ggplot2-cheatsheet-2.1-Spanish.pdf)

-   [Construye un gr치fico capa a capa](https://rpubs.com/hadley/ggplot2-layers)

-   [Elegant graphics for data analysis](https://ggplot2-book.org/)

-   [Tutorial de {ggplot2} de Cedric Scherer](https://www.cedricscherer.com/2019/08/05/a-ggplot2-tutorial-for-beautiful-plotting-in-r/)

-   [Effective Visual Communication for the Quantitative Scientist](https://ascpt.onlinelibrary.wiley.com/doi/full/10.1002/psp4.12455)

-   [Graphics principles](https://graphicsprinciples.github.io/): el tipo de gr치fico que escojamos va a depender del tipo de variable y del mensaje que queramos transmitir (es decir, del prop칩sito).

<details>

<summary>Session Info</summary>

```{r session_info}
Sys.time()
sessionInfo()
```

</details>
